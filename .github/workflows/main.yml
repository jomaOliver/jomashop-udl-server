name: Docker CI/CD (Build & Push Latest)

# This workflow triggers on every push to the 'main' branch.
on:
  push:
    branches: [ "main" ]

# Define environment variables for easy maintenance
env:
  DOCKER_REPOSITORY: jomashop-udl-server
  DOCKER_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  DOCKER_TAG: ${{ github.sha }}

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    
    steps:
      - name: ‚¨áÔ∏è Checkout code
        # Checks out the repository code
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Set up QEMU for Multi-Platform Build
        # QEMU allows building images for other architectures (like ARM)
        uses: docker/setup-qemu-action@v3

      - name: ‚öôÔ∏è Set up Docker Buildx
        # Buildx is a Docker component that extends build capabilities
        uses: docker/setup-buildx-action@v3
        
      - name: üîë Login to Docker Hub
        # Uses the secrets stored in GitHub to securely log into the Docker registry
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: üì¶ Build and push Docker image
        # This is the core step that builds the image and pushes it to Docker Hub
        uses: docker/build-push-action@v6
        with:
          # Use the root of the repo as the build context
          context: .
          # Tell the action to push the resulting image to the registry
          push: true
          # Define the tags for the image:
          # 1. :latest (for easy use)
          # 2. Commit SHA (for traceability/rollbacks)
          tags: |
            ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_REPOSITORY }}:latest
            ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_REPOSITORY }}:${{ env.DOCKER_TAG }}
          # Enable caching to speed up subsequent builds
          cache-from: type=registry,ref=${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_REPOSITORY }}:buildcache
          cache-to: type=registry,ref=${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_REPOSITORY }}:buildcache,mode=max
